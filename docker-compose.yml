version: '3.8'

# 虚拟导师系统 - Docker Compose 配置
# 注意：此配置需要GPU支持和大量存储空间

services:
  # 1. Backend API服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vt-backend
    ports:
      - "8203:8203"
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    volumes:
      - ./backend/instance:/app/instance  # 数据库持久化
      - ./backend/uploads:/app/uploads    # 文件上传
    networks:
      - vt-network
    restart: unless-stopped

  # 2. Redis缓存服务
  redis:
    image: redis:7-alpine
    container_name: vt-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - vt-network
    restart: unless-stopped

  # 3. RAG服务
  rag:
    build:
      context: ./rag
      dockerfile: Dockerfile
    container_name: vt-rag
    ports:
      - "8602:8602"
    environment:
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
    depends_on:
      - milvus
    volumes:
      - ./rag/chroma_db:/app/chroma_db
      - ./rag/milvus_kb:/app/milvus_kb
    networks:
      - vt-network
    restart: unless-stopped

  # 4. Milvus向量数据库
  milvus:
    image: milvusdb/milvus:latest
    container_name: vt-milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    depends_on:
      - etcd
      - minio
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - vt-network
    restart: unless-stopped

  # 5. etcd (Milvus依赖)
  etcd:
    image: quay.io/coreos/etcd:latest
    container_name: vt-etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd-data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379
    networks:
      - vt-network

  # 6. MinIO (Milvus依赖)
  minio:
    image: minio/minio:latest
    container_name: vt-minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio-data:/minio_data
    command: minio server /minio_data
    networks:
      - vt-network

  # 7. LLM服务 (需要Ollama)
  llm:
    build:
      context: ./llm
      dockerfile: Dockerfile
    container_name: vt-llm
    ports:
      - "8610:8610"
    environment:
      - OLLAMA_HOST=http://ollama:11434
    depends_on:
      - ollama
    volumes:
      - ./llm/checkpoints.db:/app/checkpoints.db
    networks:
      - vt-network
    restart: unless-stopped

  # 8. Ollama服务
  ollama:
    image: ollama/ollama:latest
    container_name: vt-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - vt-network
    restart: unless-stopped

  # 9. TTS服务 (Edge TTS - CPU only)
  tts:
    build:
      context: ./tts/edge
      dockerfile: Dockerfile
    container_name: vt-tts
    ports:
      - "8604:8604"
    networks:
      - vt-network
    restart: unless-stopped

  # 10. Lip-sync服务 (需要GPU!!!)
  lipsync:
    build:
      context: ./lip-sync
      dockerfile: Dockerfile
    container_name: vt-lipsync
    ports:
      - "8615:8615"
    environment:
      - TORCH_HOME=/models
      - HF_HOME=/models
      - TRANSFORMERS_CACHE=/models
      - TTS_SERVER=http://tts:8604
    depends_on:
      - tts
    volumes:
      - ./lip-sync/models:/app/models     # 8.3GB 模型文件
      - ./lip-sync/data:/app/data         # 4.1GB Avatar数据
      - model-cache:/models                # 模型缓存
    networks:
      - vt-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # 11. Frontend React应用
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vt-frontend
    ports:
      - "3002:3002"
    environment:
      - REACT_APP_API_BASE_URL=http://localhost:8203/api
      - REACT_APP_WEBRTC_URL=http://localhost:8615
    depends_on:
      - backend
      - lipsync
    networks:
      - vt-network
    restart: unless-stopped

volumes:
  redis-data:
  milvus-data:
  etcd-data:
  minio-data:
  ollama-data:
  model-cache:

networks:
  vt-network:
    driver: bridge

