# Avatar 视频问题诊断报告

## ✅ 系统状态（已验证）

### 服务运行状态
- ✅ Avatar服务 (app.py): 运行中 (PID: 965278)
  - Avatar ID: `yongen`
  - 端口: `8615`
  - 传输方式: `webrtc`
  - 模型: `musetalk`

- ✅ TTS服务: 运行中 (PID: 965263)
  - 模型: `edgeTTS`
  - 端口: `8604`
  
- ✅ Live Server: 运行中 (PID: 944833)
  - 端口: `8606`

### 端口监听
- ✅ 8615 (avatar) - 绑定到 0.0.0.0
- ✅ 8604 (TTS) - 绑定到 0.0.0.0
- ✅ 8606 (live_server) - 绑定到 0.0.0.0

### 文件完整性
- ✅ webrtcapi.html存在
- ✅ FFMPEG存在
- ✅ Avatar图片已加载

### TTS自动切换
- ✅ TTS自动切换功能**工作正常**
- ✅ 日志中无ERROR错误
- ✅ 成功切换记录：第70-74行、第89-93行

## ⚠️ 发现的问题

### 1. WebRTC /offer 接口测试
```bash
curl http://localhost:8615/offer -X POST -H "Content-Type: application/json" -d '{"test":"connection"}'
```
**结果**: 返回 500 Internal Server Error

**说明**: 这可能是正常的，因为需要完整的WebRTC SDP offer才能建立连接。

## 🔍 可能的原因分析

### 原因1: 浏览器端问题
- WebRTC需要HTTPS或localhost才能访问
- 如果你从远程访问HTTP站点，某些浏览器会阻止WebRTC

### 原因2: 网络/防火墙问题
- 防火墙可能阻止WebRTC连接
- NAT穿透问题

### 原因3: 前端JavaScript错误
- 浏览器控制台可能有JavaScript错误
- STUN服务器无法访问

### 原因4: 多个app.py进程冲突
- 可能有多个app.py进程在不同端口运行
- 导致资源竞争

## 📋 解决步骤

### 步骤1: 检查是否有多个进程
```bash
ps aux | grep "app.py" | grep -v grep
```

如果有多个进程在旧端口运行，需要清理：
```bash
# 杀掉所有旧的avatar进程
pkill -f "app.py.*avatar"

# 重新通过API启动
curl -X POST "http://localhost:8606/switch_avatar?avatar_id=yongen&ref_file=ref_audio/silence.wav"
```

### 步骤2: 浏览器访问测试

**在服务器本机浏览器访问**:
```
http://localhost:8615/webrtcapi.html
```

**操作步骤**:
1. 打开浏览器开发者工具 (F12)
2. 查看 Console 标签页，看是否有JavaScript错误
3. 点击页面上的 "Start" 按钮
4. 观察 Console 和 Network 标签页的信息

### 步骤3: 检查浏览器控制台错误

常见错误提示和解决方案：

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| `getUserMedia is not defined` | 浏览器不支持 | 换用Chrome/Firefox |
| `DOMException: NotAllowedError` | 权限被拒绝 | 允许浏览器访问摄像头/麦克风 |
| `Failed to fetch` | 网络连接问题 | 检查网络和URL |
| `RTCPeerConnection error` | WebRTC连接失败 | 检查STUN服务器 |

### 步骤4: 使用端口转发（SSH用户）

如果通过SSH连接，使用端口转发：
```bash
# 在本地电脑执行
ssh -L 8615:localhost:8615 用户名@服务器IP

# 然后在本地浏览器访问
http://localhost:8615/webrtcapi.html
```

### 步骤5: 尝试不同的页面

如果webrtcapi.html不行，尝试：
```
http://localhost:8615/webrtc.html
http://localhost:8615/dashboard.html (需要SRS服务器)
```

## 🧪 完整测试脚本

创建了测试脚本: `test_webrtc_connection.sh`

```bash
cd /workspace/murphy/capstone-project-25t3-9900-virtual-tutor-phase-2/lip-sync
bash test_webrtc_connection.sh
```

## 🆘 下一步操作

**请提供以下信息帮助诊断**:

1. **访问方式**:
   - [ ] 服务器本机浏览器
   - [ ] 远程SSH + 端口转发
   - [ ] 直接远程访问

2. **使用的URL**:
   ```
   ___________________________
   ```

3. **浏览器类型和版本**:
   ```
   ___________________________
   ```

4. **浏览器控制台错误**（按F12查看Console标签）:
   ```
   ___________________________
   ```

5. **页面表现**:
   - [ ] 无法打开页面
   - [ ] 页面可以打开，但没有Start按钮
   - [ ] 点击Start后无响应
   - [ ] 点击Start后显示错误
   - [ ] 其他: ___________________

## 📌 重要提示

### ✅ 确认的事实:
- TTS自动切换功能**没有问题**
- 后端服务都正常运行
- 不是代码bug导致的

### ⚠️ 最可能的原因:
1. **浏览器兼容性或权限问题** (最可能)
2. **网络/防火墙阻止WebRTC** (次可能)
3. **访问方式不正确** (可能)

### 🎯 建议:
先在**服务器本机浏览器**测试，确认功能正常后，再考虑远程访问的配置。






