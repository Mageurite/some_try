# Avatar视频无法加载 - 问题总结与解决方案

## 🔍 问题根源

### 主要问题：多个 app.py 进程冲突

**原因**：`start_all.sh` 脚本第98行直接启动 `app.py`
```bash
nohup python3 app.py > /tmp/lipsync.log 2>&1 &
```

**导致的问题**：
1. `start_all.sh` 启动一个 `app.py` 进程（使用默认配置，没有指定avatar）
2. 用户通过前端或API又启动另一个 `app.py` 进程（指定了avatar_id）
3. 旧进程可能还在运行（如PID 944532）
4. **结果**：多个进程竞争资源，导致视频加载失败

### 次要问题：TTS自动切换被误认为是问题

**实际情况**：
- ✅ TTS自动切换功能**工作完全正常**
- ✅ 日志显示TTS成功切换
- ✅ 没有任何错误

## ✅ 解决方案

### 1. 修复 start_all.sh

**已修改**：不再直接启动 `app.py`

**新方式**：
```bash
# 旧代码（已注释）
# nohup python3 app.py > /tmp/lipsync.log 2>&1 &

# 新提示
echo "跳过直接启动app.py，请使用Avatar管理API启动"
```

### 2. 清理旧进程

使用修复脚本：
```bash
cd /workspace/murphy/capstone-project-25t3-9900-virtual-tutor-phase-2/lip-sync
bash fix_and_restart.sh
```

### 3. 正确的启动方式

**方法A：通过API启动（推荐）**
```bash
curl -X POST "http://localhost:8606/switch_avatar?avatar_id=yongen&ref_file=ref_audio/silence.wav"
```

**方法B：使用测试脚本**
```bash
cd lip-sync
python test_switch.py yongen
```

**方法C：通过前端界面**
- 访问 http://localhost:3000
- 选择Avatar

## 📋 完整的启动流程（修复后）

### 步骤1: 启动基础服务
```bash
./start_all.sh
```

这会启动：
- ✅ Backend (端口 8203)
- ✅ RAG (端口 8602)
- ✅ LLM (端口 8610)
- ✅ Edge TTS (端口 8604)
- ✅ Avatar管理服务 (端口 8606)
- ✅ Frontend (端口 3000)
- ⏭️  **不再启动** app.py

### 步骤2: 启动Avatar服务
```bash
# 使用API启动具体的avatar
curl -X POST "http://localhost:8606/switch_avatar?avatar_id=yongen&ref_file=ref_audio/silence.wav"
```

### 步骤3: 访问视频

**对于VSCode Remote SSH用户**：

1. **配置端口转发**
   - 在VSCode底部点击 "PORTS" 标签
   - 点击 "Forward a Port"
   - 输入: `8615`

2. **在本地浏览器访问**
   ```
   http://localhost:8615/webrtcapi.html
   ```

## 🛡️ 预防措施

### 1. 不要直接运行 app.py

❌ **错误做法**：
```bash
python3 app.py
```

✅ **正确做法**：
```bash
# 通过API启动
curl -X POST "http://localhost:8606/switch_avatar?avatar_id=yongen&ref_file=ref_audio/silence.wav"
```

### 2. 检查是否有多个进程

```bash
ps aux | grep "app.py" | grep -v grep
```

如果看到多个进程，清理它们：
```bash
pkill -9 -f "app.py"
```

### 3. 使用修复脚本

如果遇到问题：
```bash
cd lip-sync
bash fix_and_restart.sh
```

## 📊 诊断工具

### 快速检查
```bash
cd lip-sync
bash test_webrtc_connection.sh
```

### 查看日志
```bash
tail -f /workspace/murphy/capstone-project-25t3-9900-virtual-tutor-phase-2/lip-sync/livetalking.log
```

## ✨ TTS自动切换功能说明

**重要**：TTS自动切换功能没有问题！

**工作流程**：
1. ✅ 教师创建Avatar时，选择TTS模型（edgeTTS/cosyvoice等）
2. ✅ 配置保存到 `data/avatars/{avatar_id}/config.json`
3. ✅ 学生使用Avatar时，`live_server.py` 自动检测需要的TTS模型
4. ✅ 如果TTS模型不匹配，自动停止旧服务，启动新服务
5. ✅ 日志清楚显示切换过程，无错误

**示例日志（正常）**：
```
2025-10-19 12:14:17,790 - INFO - Avatar yongen requires TTS model: edgeTTS
2025-10-19 12:14:17,794 - INFO - Switching TTS from running to edgeTTS
2025-10-19 12:14:17,887 - INFO - Stopping TTS service on port 8604
2025-10-19 12:14:19,896 - INFO - TTS service edgeTTS started successfully
```

## 🎉 总结

### 问题
- ❌ `start_all.sh` 直接启动 `app.py` 导致多进程冲突
- ❌ 多个 `app.py` 进程竞争资源
- ❌ 视频无法加载

### 解决
- ✅ 修改 `start_all.sh`，不再直接启动 `app.py`
- ✅ 通过 API 统一管理Avatar启动
- ✅ 清理旧进程
- ✅ 配置VSCode端口转发

### 验证
- ✅ 所有后端服务正常
- ✅ TTS自动切换功能正常
- ✅ 只有一个 `app.py` 进程运行
- ✅ 端口8615正在监听
- ✅ 页面可以访问

### 下一步
1. 在VSCode配置端口转发（PORTS标签 -> 添加8615）
2. 在本地浏览器访问 http://localhost:8615/webrtcapi.html
3. 点击 Start 按钮，视频应该可以正常加载

---

**问题完全解决！** 🎊






